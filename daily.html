<script>
  const params = new URLSearchParams(window.location.search);
  const date = params.get("date");
  if (date) document.getElementById("pageTitle").textContent = "ðŸ“˜ Journal for " + date;

  // Theme toggle
  document.getElementById("toggleTheme").addEventListener("click", () => {
    document.body.classList.toggle("dark");
    document.body.classList.toggle("light");
  });

  // Add trade
  const tradeBody = document.getElementById("tradeBody");
  document.getElementById("addTrade").addEventListener("click", () => {
    const row = document.createElement("tr");
    row.innerHTML = `
      <td><input type="text" placeholder="EUR/USD"></td>
      <td><input type="number" placeholder="1.0850"></td>
      <td><input type="number" placeholder="1.0900"></td>
      <td><input type="text" placeholder="1:3"></td>
      <td><textarea placeholder="Setup notes..."></textarea></td>
      <td><input type="number" class="pnl" placeholder="50"></td>
      <td>
        <!-- your HTML stays the same: either label+hidden input OR a plain input -->
        <input type="file" accept="image/*">
      </td>
      <td><button class="deleteRow">ðŸ—‘</button></td>`;
    tradeBody.appendChild(row);
  });

  document.addEventListener("click", e => {
    if (e.target.classList.contains("deleteRow")) {
      const tr = e.target.closest("tr");
      const idx = Array.from(tr.parentNode.children).indexOf(tr);
      // also remove its screenshot from storage
      delete shots[idx];
      persistShots();
      tr.remove();
      // re-pack the shots array so indexes match rows again
      reindexShots();
    }
  });

  // Auto Summary
  document.addEventListener("input", e => {
    if (e.target.classList.contains("pnl")) calculateSummary();
  });

  function calculateSummary() {
    const pnls = Array.from(document.querySelectorAll(".pnl")).map(p => parseFloat(p.value) || 0);
    if (pnls.length === 0) return;
    const wins = pnls.filter(v => v > 0);
    const losses = pnls.filter(v => v < 0);
    const avgWin = wins.length ? (wins.reduce((a,b) => a+b,0)/wins.length).toFixed(2) : 0;
    const avgLoss = losses.length ? (losses.reduce((a,b) => a+b,0)/losses.length).toFixed(2) : 0;
    const winRate = ((wins.length / pnls.length) * 100).toFixed(1);
    const totalRR = (wins.length - losses.length).toFixed(1);
    document.getElementById("avgWin").textContent = `$${avgWin}`;
    document.getElementById("avgLoss").textContent = `$${avgLoss}`;
    document.getElementById("winRate").textContent = `${winRate}%`;
    document.getElementById("totalRR").textContent = totalRR;
  }

  /* ========= SCREENSHOTS: PERSISTENT & AUTO-PREVIEW ========= */

  // storage for this day
  const SHOTS_KEY = `journalShots-${date}`;
  let shots = JSON.parse(localStorage.getItem(SHOTS_KEY) || "{}"); // {rowIndex: base64}

  function persistShots() {
    localStorage.setItem(SHOTS_KEY, JSON.stringify(shots));
  }

  // after deletions, keep indexes aligned with current table rows
  function reindexShots() {
    const newMap = {};
    document.querySelectorAll("#tradeBody tr").forEach((tr, i) => {
      const oldIdx = tr.dataset.idx ? parseInt(tr.dataset.idx, 10) : i;
      if (shots[oldIdx]) newMap[i] = shots[oldIdx];
      tr.dataset.idx = i;
    });
    shots = newMap;
    persistShots();
    // redraw previews to match
    restorePreviewsFromShots();
  }

  // Find or create a tiny thumbnail inside the screenshot cell
  function ensurePreviewInCell(cell) {
    let img = cell.querySelector("img.ss-prev");
    if (!img) {
      img = document.createElement("img");
      img.className = "ss-prev";
      img.style.cssText = "display:block;width:60px;height:60px;border-radius:6px;object-fit:cover;margin:4px auto;";
      cell.appendChild(img);
    }
    return img;
  }

  // Event delegation: catch BOTH your hidden input and plain input
  document.addEventListener("change", (e) => {
    const isScreenshotInput =
      e.target.matches('td input[type="file"]') ||
      e.target.matches('.image-upload input[type="file"]');

    if (!isScreenshotInput) return;

    const file = e.target.files && e.target.files[0];
    if (!file) return;

    const tr = e.target.closest("tr");
    const idx = Array.from(tr.parentNode.children).indexOf(tr);
    tr.dataset.idx = idx;

    const reader = new FileReader();
    reader.onload = (ev) => {
      const base64 = ev.target.result;

      // show thumbnail in the same cell
      const cell = e.target.closest("td");
      const img = ensurePreviewInCell(cell);
      img.src = base64;

      // save to storage
      shots[idx] = base64;
      persistShots();
    };
    reader.readAsDataURL(file);
  });

  // Draw all saved previews into the table cells
  function restorePreviewsFromShots() {
    document.querySelectorAll("#tradeBody tr").forEach((tr, i) => {
      const base64 = shots[i];
      if (!base64) return;
      const screenshotCell = tr.querySelectorAll("td")[6]; // 7th column ("Screenshot")
      if (!screenshotCell) return;
      const img = ensurePreviewInCell(screenshotCell);
      img.src = base64;
    });
  }

  /* ========= SAVE / LOAD ========= */

  // Save data
  document.getElementById("saveBtn").addEventListener("click", () => {
    const rows = Array.from(document.querySelectorAll("#tradeBody tr"));

    const trades = rows.map((tr, idx) => {
      const fields = tr.querySelectorAll("input,textarea");
      // Your column order is fixed; keep it exactly the same
      const pair  = fields[0]?.value || "";
      const entry = fields[1]?.value || "";
      const exit  = fields[2]?.value || "";
      const rr    = fields[3]?.value || "";
      const notes = fields[4]?.value || "";
      const pnl   = tr.querySelector(".pnl")?.value || "";
      const screenshot = shots[idx] || null; // attach screenshot
      return { pair, entry, exit, rr, notes, pnl, screenshot };
    });

    const data = {
      trades,
      reflection: document.getElementById("reflection").value,
      gratitude: document.getElementById("gratitude").value,
      goals: document.getElementById("goals").value,
      mood: document.querySelector("input[name='mood']:checked")?.value || ""
    };

    localStorage.setItem(`journal-${date}`, JSON.stringify(data));
    persistShots(); // make sure latest thumbnails are stored
    alert("âœ… Saved!");
  });

  // Load data
  window.addEventListener("load", () => {
    const saved = localStorage.getItem(`journal-${date}`);
    if (saved) {
      const data = JSON.parse(saved);
      if (data.trades) {
        tradeBody.innerHTML = "";
        data.trades.forEach((t, idx) => {
          const row = document.createElement("tr");
          row.dataset.idx = idx;
          row.innerHTML = `
            <td><input type="text" value="${t.pair || ""}"></td>
            <td><input type="number" value="${t.entry || ""}"></td>
            <td><input type="number" value="${t.exit || ""}"></td>
            <td><input type="text" value="${t.rr || ""}"></td>
            <td><textarea>${t.notes || ""}</textarea></td>
            <td><input type="number" class="pnl" value="${t.pnl || ""}"></td>
            <td>
              <!-- keep your markup simple; input is enough, preview is injected by JS -->
              <input type="file" accept="image/*">
            </td>
            <td><button class="deleteRow">ðŸ—‘</button></td>`;
          tradeBody.appendChild(row);

          // If screenshot was saved inside the main journal data, mirror it to shots store
          if (t.screenshot) {
            shots[idx] = t.screenshot;
          }
        });
        persistShots();
      }

      document.getElementById("reflection").value = data.reflection || "";
      document.getElementById("gratitude").value = data.gratitude || "";
      document.getElementById("goals").value = data.goals || "";
      if (data.mood) {
        const moodEl = document.querySelector(`input[name='mood'][value='${data.mood}']`);
        if (moodEl) moodEl.checked = true;
      }
    }

    // draw thumbnails from shots store (whether loaded from separate store or from data.trades)
    restorePreviewsFromShots();
    calculateSummary();
  });
</script>
